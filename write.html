<!DOCTYPE html>
<html>
<head>
    <title>Add a new note</title>

    <!-- meta -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- css -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/ionicons.min.css">
    <link rel="stylesheet" href="css/pace.css">
    <link rel="stylesheet" href="css/custom.css">
    <link rel="stylesheet" href="css/lc_gif_player.css">
    <link rel="stylesheet" href="css/simplemde.min.css">
    <!--    <link rel="stylesheet" href="css/asciidoctor.css">-->

    <!-- js -->
    <script src="js/simplemde.min.js"></script>
    <script src="js/jquery-2.1.3.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/pace.min.js"></script>
    <script src="js/modernizr.custom.js"></script>
    <style>
        #open-file-form {
            position: relative;
            min-height: 42px;
        }

        #open-file-form input[type=search] {
            width: 100%;
            position: absolute;
            left: 0;
            padding: 10px 30px 10px 10px;
            border: 1px solid #ddd;
            z-index: 99;
        }

        #open-file-form button {
            position: absolute;
            right: 6px;
            top: 4px;
            z-index: 999;
            background: transparent;
            border: 0;
            padding: 0;
        }

        #open-file-form button span {
            font-size: 26px;
        }

    </style>
</head>

<body id="single">
<input type="file" id="uploader" style="display: none" accept="image/*">
<div class="container">
    <header id="site-header">
        <div class="row">
            <div class="col-md-4 col-sm-5 col-xs-8">
                <div class="logo">
                    <h1><a href="index.html"><b>Konoplev's</b> garden</a></h1>
                </div>
            </div><!-- col-md-4 -->
            <div class="col-md-8 col-sm-7 col-xs-4">
                <nav class="main-nav" role="navigation">
                    <div class="navbar-header">
                        <button type="button" id="trigger-overlay" class="navbar-toggle">
                            <span class="ion-navicon"></span>
                        </button>
                    </div>

                    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                        <ul class="nav navbar-nav navbar-right">
                            <li class="cl-effect-11"><a href="index.html" data-hover="Garden">Garden</a></li>
                            <li class="cl-effect-11"><a href="http://konoplev.me" data-hover="Blog">Blog</a></li>
                        </ul>
                    </div><!-- /.navbar-collapse -->
                </nav>
                <div id="header-search-box">
                    <a id="search-menu" href="#"><span id="search-icon" class="ion-ios-search-strong"></span></a>
                    <div id="search-form" class="search-form">
                        <form role="search" method="get" id="searchform" action="#">
                            <input type="search" placeholder="Search" required class="search-input">
                            <button type="submit"><span class="ion-ios-search-strong"></span></button>
                        </form>
                    </div>
                </div>
            </div><!-- col-md-8 -->
        </div>
    </header>
</div>

<div class="content-body">
    <div class="container">
        <div class="row">
            <main class="col-md-12">
                <div>
                    <article class="post post-1">
                        <header class="entry-header">
                            <h1 class="entry-title">Add a new note</h1>
                            <div id="editor-holder">
                                <textarea id="editor"></textarea>
                            </div>
                        </header>
                        <article class="post">
                            <div class="entry-content clearfix">
                                <p>
                                <div role="search" id="open-file-form">
                                    <input type="search" class="search-input" id="open-file-input" placeholder="Search" required>

                                </div>
                                </p>
                                <div class="height-40px"></div>
                            </div>
                            <div class="entry-content clearfix">
                                <p>
                                <form role="search" method="get" id="searchform" action="#">
                                    <input type="search" class="search-input" placeholder="Search" required>
                                    <button type="submit"><span class="ion-ios-search-strong"></span></button>
                                </form>
                                </p>
                                <div class="height-40px"></div>
                            </div>
                        </article>
                        <article class="post">
                            <div class="entry-content clearfix">
                                <p id="inbox">
                                    <button onclick="showFile('Some_name.adoc');">Some_name.adoc</button>
                                    <br>
                                    <button onclick="showFile('Some_name.adoc');">Some_name.adoc</button>
                                </p>
                                <div class="height-40px"></div>
                            </div>
                        </article>
                        <div id="content-holder">
                        </div>
                        <div class="height-40px"></div>
                        <div>
                            <div id="remark42" aria-live="polite">
                                <noscript>Please enable JavaScript to view the comments</noscript>
                            </div>
                        </div>

                    </article>
                </div>
            </main>
        </div>
    </div>
</div>

<footer id="site-footer">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <p class="copyright">&copy; 2020 Konoplev.me</p>
            </div>
        </div>
    </div>
</footer>

<!-- Mobile Menu -->
<div class="overlay overlay-hugeinc">
    <button type="button" class="overlay-close"><span class="ion-ios-close-empty"></span></button>
    <nav>
        <ul>
            <li><a href="index.html">Garden</a></li>
            <li><a href="http://konoplev.me">Blog</a></li>
        </ul>
    </nav>
</div>

<script src="js/script.js" type="module"></script>
<script src="js/asciidoctor.min.js"></script>
<script type="module">
    let today = new Date().toISOString().slice(0, 10);
    let defaultText = `= Name me
Alexander Konoplev
v 1.0, ${today}
:tags:

[intro]

== Links

<<file.adoc#,Parent>>

    `;
    let pageRequest = new URL(window.location.href);
    let email = pageRequest.searchParams.get("email");
    let secret = pageRequest.searchParams.get("secret");
    let barer = "Basic " + pageRequest.searchParams.get("token");

    var url = "https://notes.konoplev.me/api";

    //auth
    $.ajax({
        url: url + '/oauth/token',
        type: 'POST',
        headers: {Authorization: barer},
        data: jQuery.param({
            client_id: "web",
            grant_type: "password",
            username: email,
            password: secret
        }),
        processData: false,
        contentType: 'application/x-www-form-urlencoded; charset=UTF-8'
    }).done(function (data) {
        console.log(data);
        showEditor(barer, data.refresh_token, defaultText);
        showInbox(barer, data.refresh_token);
    }).fail(function () {
        alert("Sorry you don't have permissions to write");
    });

    function showInbox(barer, refresh_token) {
        runRequest(barer, refresh_token, access_token => {
            $.ajax({
                url: url + '/in-progress',
                type: 'GET',
                headers: {Authorization: "Bearer " + access_token},
                processData: false,
                contentType: false                    // Using FormData, no need to process data.
            }).done(function (files) {
                console.log("Success: Get inbox!");
                // editor.options.promptTexts.image = url;
                $("#inbox").empty();
                files.forEach(file => {
                    $("#inbox").append(
                        "<button onClick=\"showFile('" + file + "', '" + barer + "', '" + refresh_token + "')\">" + file + "</button> <br>"
                    );
                })
                $("#open-file-form").append(
                    "<button id=\"open-file\" onClick=\"openFile('" + barer + "', '" + refresh_token + "')\">" + "<span class=\"ion-ios-folder-outline\"></span></button>"
                )
                console.log(files);
            }).fail(function () {
                alert("Can't connect to server");
            });
        });
    }


</script>
<script>
    var url = "https://notes.konoplev.me/api";

    function openFile(barer, refresh_token) {

        let value = $('#open-file-input').val();
        let slash = value.lastIndexOf("/");
        let endOfFileName = value.indexOf(".html")
        let fileName = value.substring(slash + 1, endOfFileName);
        showFile(fileName + ".adoc", barer, refresh_token);
    }
    function showFile(name, barer, refresh_token) {
        runRequest(barer, refresh_token,
            access_token => {
                $.ajax({
                    url: url + '/note?fileName=' + name,
                    type: 'GET',
                    headers: {Authorization: "Bearer " + access_token},
                    processData: false,
                    contentType: false                    // Using FormData, no need to process data.
                }).done(function (content) {
                    console.log("Success: Get conent!");
                    // editor.options.promptTexts.image = url;
                    showEditor(barer, refresh_token, content);
                }).fail(function () {
                    alert("Can't connect to server ");
                });
            }
        );
    }

    function runRequest(barer, refresh_token, request) {
        $.ajax({
            url: url + '/oauth/token',
            type: 'POST',
            headers: {Authorization: barer},
            data: jQuery.param({
                client_id: "web",
                grant_type: "refresh_token",
                refresh_token: refresh_token
            }),
            processData: false,
            contentType: 'application/x-www-form-urlencoded; charset=UTF-8'
        }).done(function (data) {
            request(data.access_token);
        }).fail(function () {
            alert("Sorry you don't have permissions to write");
        });

    }

    function showEditor(barer, refresh_token, text) {
        $("#editor-holder").empty();
        $("#editor-holder").append("<textarea spellcheck=\"false\" contenteditable=\"true\" id=\"editor\"></textarea>")
        var asciidoctor = Asciidoctor()
        var simplemde = new SimpleMDE({
            spellChecker: false,
            autofocus: true,
            styleSelectedText: false,
            blockStyles: {
                bold: "*",
                italic: "_",
                code: "--------------\n"
                //  strikethrough: "[source,java]\n-----------\n-----------"
            },
            toolbar: [
                {
                    name: "bold",
                    action: SimpleMDE.toggleBold,
                    className: "fa fa-bold",
                    title: "Bold",
                },
                {
                    name: "italic",
                    action: SimpleMDE.toggleItalic,
                    className: "fa fa-italic",
                    title: "Italic",
                },
                {
                    name: "strikethrough",
                    action: SimpleMDE.toggleStrikethrough,
                    className: "fa fa-strikethrough",
                    title: "Strikethrough",
                },
                {
                    name: "heading",
                    action: SimpleMDE.toggleHeadingSmaller,
                    className: "fa fa-header",
                    title: "Heading",
                },
                {
                    name: "code",
                    action: SimpleMDE.toggleCodeBlock,
                    className: "fa fa-code",
                    title: "Code",
                },
                "|",
                {
                    name: "quote",
                    action: SimpleMDE.toggleBlockquote,
                    className: "fa fa-quote-left",
                    title: "Quote",
                },
                {
                    name: "unordered-list",
                    action: SimpleMDE.toggleUnorderedList,
                    className: "fa fa-list-ul",
                    title: "Generic List",
                },
                {
                    name: "ordered-list",
                    action: SimpleMDE.toggleOrderedList,
                    className: "fa fa-list-ol",
                    title: "Numbered List",
                },
                {
                    name: "link",
                    action: SimpleMDE.drawLink,
                    className: "fa fa-link",
                    title: "Create Link",
                },
                {
                    name: "image",
                    action: function customFunction(editor) {
                        $("#uploader").trigger('click');
                        $("#uploader").change(function () {
                            var fd = new FormData();
                            var files = $('#uploader')[0].files[0];
                            fd.append('file', files);
                            runRequest(barer, refresh_token, access_token => {
                                $.ajax({
                                    url: url + '/image',
                                    type: 'POST',
                                    headers: {Authorization: "Bearer " + access_token},
                                    data: fd, // The form with the file inputs.
                                    processData: false,
                                    contentType: false                    // Using FormData, no need to process data.
                                }).done(function (fileName) {
                                    console.log("Success: Files sent!");
                                    // editor.options.promptTexts.image = url;
                                    editor.options.insertTexts.image = ["image::" + fileName, "[name me]"];
                                    SimpleMDE.drawImage(editor);
                                }).fail(function () {
                                    alert("Can't connect to server");
                                });
                            })
                        });

                    },
                    className: "fa fa-picture-o",
                    title: "Insert Image",
                },
                {
                    name: "table",
                    action: SimpleMDE.drawTable,
                    className: "fa fa-table",
                    title: "Insert Table",
                },
                "|",
                {
                    name: "preview",
                    action: SimpleMDE.togglePreview,
                    className: "fa fa-eye no-disable",
                    title: "Toggle Preview",
                },
                {
                    name: "side-by-side",
                    action: SimpleMDE.toggleSideBySide,
                    className: "fa fa-columns no-disable no-mobile",
                    title: "Toggle Side by Side",
                },
                {
                    name: "fullscreen",
                    action: SimpleMDE.toggleFullScreen,
                    className: "fa fa-arrows-alt no-disable no-mobile",
                    title: "Toggle Fullscreen",
                },
                "|",
                {
                    name: "save",
                    action: function (editor) {
                        runRequest(barer, refresh_token, access_token => {
                            $.ajax({
                                url: url + '/note',
                                type: 'POST',
                                headers: {Authorization: "Bearer " + access_token},
                                data: simplemde.value(), // The form with the file inputs.
                                processData: false,
                                contentType: 'application/json; charset=utf-8'
                            }).done(function (fileName) {
                                console.log("Success: Files sent!");
                                // editor.options.promptTexts.image = url;
                                location.reload();
                            }).fail(function () {
                                alert("Can't connect to server");
                            });
                        })
                    },
                    className: "fa fa-save",
                    title: "Save file",
                },
            ],
            //toolbar: ["bold", "italic", "strikethrough", "heading", "code", "|", "quote", "unordered-list", "ordered-list", "clean-block", "link", "image", "table", "horizontal-rule", "|", "preview", "side-by-side", "fullscreen"],
            element: document.getElementById("editor"),
            insertTexts: {
                horizontalRule: ["", "\n\n-----\n\n"],
                image: ["![](http://", ")"],
                link: ["http://", "[]"],
                table: ["[options=\"header\"]\n|=======================", "\n| Column 1 | Column 2 | Column 3 \n| Text             | Text             | Text \n|=======================\n"],
            },
            lineWrapping: true,
            showIcons: ["toggleBlockquote", "toggleBold", "cleanBlock", "toggleHeadingSmaller", "toggleItalic", "drawLink", "toggleUnorderedList", "togglePreview", "toggleCodeBlock", "drawImage", "toggleOrderedList", "toggleHeadingBigger", "toggleSideBySide", "toggleFullScreen"],
            shortcuts: {
                drawTable: "Cmd-Alt-T"
            },
            previewRender: function (plainText) {
                return asciidoctor.convert(plainText); // Returns HTML from a custom parser
            },
            previewRender: function (plainText, preview) { // Async method
                setTimeout(function () {
                    preview.innerHTML = asciidoctor.convert(plainText);
                }, 250);

                return "Loading...";
            }
        });
        simplemde.value(text);
    }

</script>

</body>
</html>
