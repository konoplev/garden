<!DOCTYPE html>
<html>
<head>
    <title>Name me</title>

    <!-- meta -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- css -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/ionicons.min.css">
    <link rel="stylesheet" href="css/pace.css">
    <link rel="stylesheet" href="css/custom.css">
    <link rel="stylesheet" href="css/lc_gif_player.css">

    <!-- js -->
    <script src="js/jquery-2.1.3.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/pace.min.js"></script>
    <script src="js/modernizr.custom.js"></script>
</head>

<body id="single">
<div class="container">
    <header id="site-header">
        <div class="row">
            <div class="col-md-4 col-sm-5 col-xs-8">
                <div class="logo">
                    <h1><a href="index.html"><b>Konoplev's</b> garden</a></h1>
                </div>
            </div><!-- col-md-4 -->
            <div class="col-md-8 col-sm-7 col-xs-4">
                <nav class="main-nav" role="navigation">
                    <div class="navbar-header">
                        <button type="button" id="trigger-overlay" class="navbar-toggle">
                            <span class="ion-navicon"></span>
                        </button>
                    </div>

                    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                        <ul class="nav navbar-nav navbar-right">
                            <li class="cl-effect-11"><a href="index.html" data-hover="Garden">Garden</a></li>
                            <li class="cl-effect-11"><a href="http://konoplev.me" data-hover="Blog">Blog</a></li>
                        </ul>
                    </div><!-- /.navbar-collapse -->
                </nav>
                <div id="header-search-box">
                    <a id="search-menu" href="#"><span id="search-icon" class="ion-ios-search-strong"></span></a>
                    <div id="search-form" class="search-form">
                        <form role="search" method="get" id="searchform" action="#">
                            <input type="search" placeholder="Search" required class="search-input">
                            <button type="submit"><span class="ion-ios-search-strong"></span></button>
                        </form>
                    </div>
                </div>
            </div><!-- col-md-8 -->
        </div>
    </header>
</div>


<div class="content-body">
    <div class="container">
        <div class="row">
            <main class="col-md-12">
                <div id="content-holder">
                    <article class="post post-1">
                        <header class="entry-header">
                            <h1 class="entry-title">Name me</h1>
                            <div class="entry-meta">
                            <span class="post-date"><a href="#"><time class="entry-date"
                                                                      datetime="2020-12-01T23:00:00Z">Dec 2, 2020</time></a></span>

                                <span class="post-category">
                                                                        <a href="relational_dbs.html"> #relational_dbs</a>
                                                                    </span>

                                                            </div>
                        </header>
                        <div class="entry-content clearfix">
                            <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>How transactions work internally</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_transactions">Transactions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Transactions are needed to update data consistently (you update multiple objects or multiple parts of same object at once and you need to avoid conflicts during update).</p>
</div>
<div class="paragraph">
<p>ACID.</p>
</div>
<div class="paragraph">
<p>Atomicy - if one of the writes failed - previous writes discurded.</p>
</div>
<div class="paragraph">
<p>Consistency - uniqueness or foreign key constraints. but in general it&#8217;s your responisibility. DB can&#8217;t guarantee that users age and year of birth are consistent for example.</p>
</div>
<div class="paragraph">
<p>Isolation - there are multiple levels, but in general one transaction should see changes made by parallel transaction (if parallel transaction made several writes, this transaction see all writes or no writes, but not some subset). It could lead to conflicts. Levels are how to avoid or resolve conflicts.</p>
</div>
<div class="paragraph">
<p>Durability - commited data is always availiable. Even if there is a hardware failure. It&#8217;s your responsibility in most of the cases actually. Replication and stuff like this.</p>
</div>
<div class="paragraph">
<p>Atomicy and Isolation: What could happen between BEGIN TRANSACTION and COMMIT if there are two transactions working on the same data.</p>
</div>
<div class="sect2">
<h3 id="_isolation_reads">Isolation. Reads</h3>
<div class="paragraph">
<p>One transaction reads and at the same time another transaction writes.</p>
</div>
<div class="paragraph">
<p>Possible Problems:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Dirty reads (If a transaction needs to update several objects, a dirty read means that another transaction may see some of the updates but not others)</p>
</li>
<li>
<p>Non repeatable read (Read scew) (One transaction updates two tables another one reads updating data. Reading transaction see data from first table before writing transaction commited and the data from second table when writting transaction is commited. So the data is inconsistent for reading transaction)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>First problem solution: keep new values unwritten until transaction is done.</p>
</div>
<div class="paragraph">
<p>Second problem solution: MVCC. Snapshot isolation.</p>
</div>
</div>
<div class="sect2">
<h3 id="_atomicy_writes">Atomicy. Writes</h3>
<div class="paragraph">
<p>One transaction writes and at the same time another transaction writes.</p>
</div>
<div class="paragraph">
<p>Possible Problems:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Dirty wrties (One client overwrites data that another client has written, but not yet committed. Almost all transaction implementations prevent dirty writes.)</p>
</li>
<li>
<p>Lost update (Two clients concurrently perform a read-modify-write cycle. One overwrites the otherâ€™s write without incorporating its changes, so data is lost. )</p>
</li>
<li>
<p>Write Scew (Phantoms) (A transaction reads something, makes a decision based on the value it saw, and writes the decision to the database. However, by the time the write is made, the premise of the decision is no longer true)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Solution of first: no dirty reads prevent dirty writes.</p>
</div>
<div class="paragraph">
<p>Second solution: exclusive lock (select for update MySQL), or optimistic locks and failed transaction of MVCC shows that update lost.</p>
</div>
<div class="paragraph">
<p>Third solutions: 2 Phase locking, Serializable Snapshot Isolation (optimistic lock)</p>
</div>
</div>
<div class="sect2">
<h3 id="_isolation_levels_in_databases">Isolation levels in databases</h3>
<div class="paragraph">
<p>So there are following transaction layers in PostgreSQL and MySQL</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Isolation Level</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dirty Read</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nonrepeatable Read</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Phantom Read</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read uncommitted</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Possible</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Possible</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Possible</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read committed (old and new values are kept)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not possible</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Possible</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Possible</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Repeatable read (snapshot isolation)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not possible</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not possible</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Possible</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Serializable	(2PL or serializable snapshot isolation)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not possible</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not possible</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not possible</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>PostgreSQL <em>Repeatable read</em> prevents lost update, MySQL&#8217;s repeatable read doesn&#8217;t.</p>
</div>
<div class="paragraph">
<p>Serializable is implemented as SSI in Postgress and 2PL in MySQL.</p>
</div>
<div class="paragraph">
<p><em>Dirty read</em>: Deutsche bank. One transaction tranfer moner from Account A to B. Another transaction reads after money are gone from Account A, but has not been yet received by account B. Solution: keep both values and allow transaction to see only commited values.</p>
</div>
<div class="paragraph">
<p><em>Dirty write (Repeatable read)</em>: Two same transaction. First read how much money on Account A after that second transaction transfers the money, then first transaction reads money from account B. It sees inconsisten ammount of money. Solution: snapshot isolation (MVCC). Each transaction has id. It sees only values with this id or lower.</p>
</div>
<div class="paragraph">
<p><em>Lost update</em>: <code>UPDATE counters SET value = value + 1 WHERE key = 'foo';</code> second transaction rewrites first value. MySql <code>SELECT â€¦â€‹ FOR UPDATE</code> to have exclusive lock. Postgress MVCC with detection that both transactions saw same value and tries to update it.</p>
</div>
<div class="paragraph">
<p><em>Write scew (Serializable)</em>: Two transactions read same values but updates different fields of this value and make data inconsistent. 2PL or serializable snapshot isolation (optimistic locking).</p>
</div>
</div>
<div class="sect2">
<h3 id="_solutions">Solutions</h3>
<div class="sect4">
<h5 id="_read_committed_no_dirty_reads_writes">Read Committed - no dirty reads/writes</h5>
<div class="paragraph">
<p>No dirty writes implemented by locks.</p>
</div>
<div class="paragraph">
<p>No dirty reads (could be like writes, but performance is bad (why? example!) ). Implemented as <strong>snapshot isolation (repeatable read)</strong>.</p>
</div>
<div class="paragraph">
<p>Because database maintains several versions of an object side by side, this technique is known as multi-version concurrency control (MVCC)</p>
</div>
<div class="paragraph">
<p>Each transaction has always-increasing unique txid. Any write has txid.</p>
</div>
<div class="paragraph">
<p>an object is visible if both of the following conditions are true:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>At the time when the readerâ€™s transaction started, the transaction that created the object had already committed.</p>
</li>
<li>
<p>The object is not marked for deletion, or if it is, the transaction that requested deletion had not yet committed at the time when the readerâ€™s transaction started.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>How do indexes work in a multi-version database? One option is to have the index simply point to all versions of an object and require an index query to filter out any object versions that are not visible to the current transaction.</p>
</div>
</div>
<div class="sect4">
<h5 id="_lost_update">Lost Update</h5>
<div class="paragraph">
<p>Two parallel transactions read same data and update it. Last commited transaction rewrite first commited.</p>
</div>
<div class="paragraph">
<p>Solutions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Lock</p>
</li>
<li>
<p>Run all atomic transactions in one thread</p>
</li>
<li>
<p>Detect and fail transaction.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>MySQL doesn&#8217;t detect lost update.</p>
</div>
</div>
<div class="sect4">
<h5 id="_write_skew">Write skew</h5>
<div class="paragraph">
<p>Two treads read 2 fields and based on one field value write to another field. The write to different fields, so it can&#8217;t be detected by database.</p>
</div>
<div class="paragraph">
<p>List of on call doctors.</p>
</div>
<div class="paragraph">
<p>SELECT &#8230;&#8203; FOR UPDATE in MySql can be used to avoid this problem.</p>
</div>
</div>
<div class="sect4">
<h5 id="_serializability">Serializability</h5>
<div class="paragraph">
<p>It guarantees that even though transactions may execute in parallel, the end result is the same as if they had executed one at a time, serially, without any concurrency.</p>
</div>
<div class="paragraph">
<p>Implementation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Actual Serial Execution. Redis. Transactions should be short. Itâ€™s only one thread.</p>
</li>
<li>
<p>Two-Phase Locking (2PL) (pessimistic locking). To read acuare a read lock (shared lock), to write acuare a write lock (exclusive). Write can&#8217;t be done until other transactions released all read and write locks. Read can&#8217;t be done, until other transactions release</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_links">Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="file.html">Parent</a></p>
</div>
</div>
</div>
                        </div>
                        <div class="height-40px"></div>
                        <div>
                            <div id="remark42" aria-live="polite">
                                <noscript>Please enable JavaScript to view the comments</noscript>
                            </div>
                        </div>

                    </article>
                </div>
            </main>
        </div>
    </div>
</div>

<footer id="site-footer">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <p class="copyright">&copy; 2020 Konoplev.me</p>
            </div>
        </div>
    </div>
</footer>

<!-- Mobile Menu -->
<div class="overlay overlay-hugeinc">
    <button type="button" class="overlay-close"><span class="ion-ios-close-empty"></span></button>
    <nav>
        <ul>
            <li><a href="index.html">Garden</a></li>
            <li><a href="http://konoplev.me">Blog</a></li>
        </ul>
    </nav>
</div>

<script src="js/script.js" type="module"></script>
<script>
    var remark_config = {
        host: "https://comments.konoplev.me",
        site_id: 'konoplev',
    };

    (function (c) {
        for (var i = 0; i < c.length; i++) {
            var d = document, s = d.createElement('script');
            s.src = remark_config.host + '/web/' + c[i] + '.js';
            s.defer = true;
            (d.head || d.body).appendChild(s);
        }
    })(remark_config.components || ['embed']);
</script>

</body>
</html>
